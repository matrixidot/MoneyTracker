<Window x:Class="MoneyTracker.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        xmlns:dat="clr-namespace:System.Windows.Data;assembly=PresentationFramework"
        xmlns:vm="clr-namespace:MoneyTracker.ViewModels"
        xmlns:models="clr-namespace:MoneyTracker.Models"
        xmlns:conv="clr-namespace:MoneyTracker.Converters"
        Title="MoneyTracker" Height="650" Width="1100"
        WindowStartupLocation="CenterScreen">

    <!-- Pure MVVM: Window owns its VM -->
    <Window.DataContext>
        <vm:MainViewModel/>
    </Window.DataContext>

    <Window.Resources>
        <!-- Enum values for the Type dropdown -->
        <dat:ObjectDataProvider x:Key="TransactionTypes"
                                MethodName="GetValues"
                                ObjectType="{x:Type sys:Enum}">
            <dat:ObjectDataProvider.MethodParameters>
                <x:Type TypeName="models:TransactionType"/>
            </dat:ObjectDataProvider.MethodParameters>
        </dat:ObjectDataProvider>

        <!-- Converter: CategoryId + Categories[] -> Category name -->
        <conv:CategoryIdToNameConverter x:Key="CategoryIdToNameConverter"/>

        <!-- Optional: simple invalid-row highlighting -->
        <Style x:Key="TransactionRowStyle" TargetType="DataGridRow">
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsValid}" Value="False">
                    <Setter Property="Background" Value="#33FF0000"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </Window.Resources>

    <DockPanel Margin="12">

        <!-- Toolbar -->
        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="0,0,0,8">
            <Button Content="Add Row" Width="90" Margin="0,0,8,0"
                    Command="{Binding AddRowCommand}"/>

            <Button Content="Delete Row" Width="90" Margin="0,0,8,0"
                    Command="{Binding DeleteRowCommand}"/>

            <Button Content="Save" Width="90" Margin="0,0,8,0"
                    Command="{Binding SaveCommand}"/>

            <Button Content="Refresh" Width="90"
                    Command="{Binding RefreshCommand}"/>

            <TextBlock Margin="16,0,0,0"
                       VerticalAlignment="Center"
                       Text="{Binding StatusText}"/>
        </StackPanel>

        <!-- Spreadsheet grid -->
        <DataGrid ItemsSource="{Binding Rows}"
                  SelectedItem="{Binding SelectedRow, Mode=TwoWay}"
                  AutoGenerateColumns="False"
                  CanUserAddRows="False"
                  CanUserDeleteRows="False"
                  IsReadOnly="False"
                  SelectionMode="Single"
                  SelectionUnit="FullRow"
                  HeadersVisibility="Column"
                  GridLinesVisibility="All"
                  RowStyle="{StaticResource TransactionRowStyle}">

            <DataGrid.Columns>

                <!-- Date -->
                <DataGridTemplateColumn Header="Date" Width="140">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding Date, StringFormat=yyyy-MM-dd}"
                                       VerticalAlignment="Center"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                    <DataGridTemplateColumn.CellEditingTemplate>
                        <DataTemplate>
                            <DatePicker SelectedDate="{Binding Date, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellEditingTemplate>
                </DataGridTemplateColumn>

                <!-- Type (Expense/Income) -->
                <DataGridTemplateColumn Header="Type" Width="120">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding Type}" VerticalAlignment="Center"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                    <DataGridTemplateColumn.CellEditingTemplate>
                        <DataTemplate>
                            <ComboBox ItemsSource="{Binding Source={StaticResource TransactionTypes}}"
                                      SelectedItem="{Binding Type, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellEditingTemplate>
                </DataGridTemplateColumn>

                <!-- Category -->
                <DataGridTemplateColumn Header="Category" Width="220">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock VerticalAlignment="Center">
                                <TextBlock.Text>
                                    <!-- MultiBinding: CategoryId + Categories -> display name -->
                                    <MultiBinding Converter="{StaticResource CategoryIdToNameConverter}">
                                        <Binding Path="CategoryId"/>
                                        <Binding Path="DataContext.Categories"
                                                 RelativeSource="{RelativeSource AncestorType=Window}"/>
                                    </MultiBinding>
                                </TextBlock.Text>
                            </TextBlock>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>

                    <DataGridTemplateColumn.CellEditingTemplate>
                        <DataTemplate>
                            <ComboBox ItemsSource="{Binding DataContext.Categories, RelativeSource={RelativeSource AncestorType=Window}}"
                                      DisplayMemberPath="Name"
                                      SelectedValuePath="Id"
                                      SelectedValue="{Binding CategoryId, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellEditingTemplate>
                </DataGridTemplateColumn>

                <!-- Name -->
                <DataGridTextColumn Header="Name" Width="*"
                                    Binding="{Binding Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>

                <!-- Cost -->
                <DataGridTextColumn Header="Cost" Width="120"
                                    Binding="{Binding Cost, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, StringFormat=F2}"/>

            </DataGrid.Columns>
        </DataGrid>

    </DockPanel>
</Window>
